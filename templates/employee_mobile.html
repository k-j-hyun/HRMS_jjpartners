<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS ì§ì›ìš©</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#212529">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="HRMS">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #212529;
            line-height: 1.6;
        }
        
        .header {
            background: #212529;
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .user-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .container {
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        
        .status-card {
            text-align: center;
            background: #495057;
            color: white;
        }
        
        .status-indicator {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .status-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .status-details {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .location-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
        }
        
        .location-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .location-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .location-icon.active {
            background: #28a745;
        }
        
        .coordinates {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
            text-decoration: none;
            text-align: center;
        }
        
        .btn-primary {
            background: #495057;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #343a40;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-info {
            background: #6c757d;
            color: white;
            text-decoration: none;
            display: block;
        }
        
        .btn-info:hover {
            background: #5a6268;
            text-decoration: none;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .work-time {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .time-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .time-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .time-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
        }
        
        .work-schedule {
            margin-bottom: 1rem;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 0.5rem;
            border-left: 3px solid #007bff;
        }

        .schedule-item.completed {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .schedule-item.working {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .schedule-info {
            flex: 1;
        }

        .schedule-title {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .schedule-details {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .schedule-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .activity-log {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .activity-icon.check-in {
            background: #28a745;
        }
        
        .activity-icon.check-out {
            background: #dc3545;
        }
        
        .activity-icon.location {
            background: #17a2b8;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 0.25rem;
        }
        
        .activity-time {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .location-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .location-detail:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 0.9rem;
            color: #495057;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        .alert {
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        
        .footer {
            text-align: center;
            padding: 2rem 1rem;
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        /* ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¸ë””ì¼€ì´í„° */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
        }
        
        .live-dot {
            width: 6px;
            height: 6px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50% auto;
            padding: 1.5rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            transform: translateY(-50%);
        }
        
        .modal-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .modal-footer {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="title">HRMS</div>
            <div class="user-info">
                <span id="employeeName">ì§ì›</span>
                <button onclick="logout()" style="background: none; border: none; color: white; padding: 0.25rem 0.5rem;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- í˜„ì¬ ìƒíƒœ ì¹´ë“œ -->
        <div class="card status-card">
            <div class="status-indicator" id="statusIndicator">â°</div>
            <div class="status-text" id="statusText">ì¶œê·¼ ëŒ€ê¸°ì¤‘</div>
            <div class="status-details" id="statusDetails">ì¶œê·¼ ì‹œê°„ì´ ë˜ë©´ ì²´í¬ì¸í•˜ì„¸ìš”</div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
            </div>
        </div>

        <!-- ìœ„ì¹˜ ì •ë³´ ì¹´ë“œ -->
        <div class="card location-card">
            <div class="location-status">
                <div class="location-icon" id="locationIcon"></div>
                <span id="locationStatus">ìœ„ì¹˜ í™•ì¸ ì¤‘...</span>
            </div>
            <div id="locationDetails">GPS ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.</div>
            <div class="coordinates" id="coordinates">ì¢Œí‘œ: í™•ì¸ ì¤‘</div>
        </div>

        <!-- ì„ íƒëœ ê·¼ë¬´ì§€ ì •ë³´ -->
        <div class="card" id="selectedLocationCard" style="display: none;">
            <div class="section-title">ì„ íƒëœ ê·¼ë¬´ì§€</div>
            <div id="selectedLocationInfo">
                <div class="location-detail">
                    <div class="detail-label">ê·¼ë¬´ì§€:</div>
                    <div class="detail-value" id="selectedJobTitle">-</div>
                </div>
                <div class="location-detail">
                    <div class="detail-label">íšŒì‚¬:</div>
                    <div class="detail-value" id="selectedCompanyName">-</div>
                </div>
                <div class="location-detail">
                    <div class="detail-label">ì£¼ì†Œ:</div>
                    <div class="detail-value" id="selectedWorkAddress">-</div>
                </div>
                <div class="location-detail">
                    <div class="detail-label">ê·¼ë¬´ì‹œê°„:</div>
                    <div class="detail-value" id="selectedWorkHours">-</div>
                </div>
                <div class="location-detail">
                    <div class="detail-label">ì‹œê¸‰:</div>
                    <div class="detail-value" id="selectedSalary">-</div>
                </div>
            </div>
        </div>

        <!-- ì£¼ìš” ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
        <div class="card">
            <button class="btn btn-primary" id="mainActionBtn" onclick="performMainAction()">
                ìœ„ì¹˜ í™•ì¸
            </button>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="refreshLocation()">ìœ„ì¹˜ ìƒˆë¡œê³ ì¹¨</button>
                <button class="btn btn-secondary" onclick="viewHistory()">ì¶œì… ê¸°ë¡</button>
            </div>
            <div class="btn-group" style="margin-top: 1rem;">
                <a href="/jobs" class="btn btn-info">ì±„ìš© ê²Œì‹œíŒ</a>
                <a href="/my-applications" class="btn btn-info">ë‚˜ì˜ ì‹ ì²­</a>
            </div>
        </div>

        <!-- ê·¼ë¬´ ì‹œê°„ ì •ë³´ -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; font-size: 1rem; color: #495057;">ê¸ˆì¼ ê·¼ë¬´ ì •ë³´</h3>
            <div class="work-time">
                <div class="time-item">
                    <div class="time-label">ì¶œê·¼ ì‹œê°„</div>
                    <div class="time-value" id="checkInTime">ë¯¸ì¶œê·¼</div>
                </div>
                <div class="time-item">
                    <div class="time-label">ê·¼ë¬´ ì‹œê°„</div>
                    <div class="time-value" id="workDuration">0ì‹œê°„</div>
                </div>
            </div>
        </div>

        <!-- ê·¼ë¬´ ì¼ì • ë° ì™„ë£Œ ëª©ë¡ -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; font-size: 1rem; color: #495057;">ê·¼ë¬´ ì¼ì • & ì™„ë£Œ ëª©ë¡</h3>
            <div class="work-schedule" id="workSchedule">
                <div class="loading">ê·¼ë¬´ ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ìµœê·¼ í™œë™ ë¡œê·¸ -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; font-size: 1rem; color: #495057;">ìµœê·¼ í™œë™</h3>
            <div class="activity-log" id="activityLog">
                <div class="loading">í™œë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">í™•ì¸</div>
            <div class="modal-body" id="modalMessage">ì‘ì—…ì„ ìˆ˜í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="confirmBtn" onclick="confirmAction()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div class="footer">
        Â© 2025 k-j-hyun & JJPartners. All rights reserved.
    </div>

    <script>
        let currentEmployee = null;
        let currentLocation = null;
        let workStatus = 'waiting'; // waiting, working, completed
        let trackingEnabled = false;
        let trackingInterval = null;
        let pendingAction = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            checkAuth();
            initializeApp();
            loadSelectedLocationInfo(); // ì„ íƒëœ ìœ„ì¹˜ ì •ë³´ ë¡œë“œ
            loadWorkSchedule(); // ê·¼ë¬´ ì¼ì • ë¡œë“œ
        };

        // ì¸ì¦ í™•ì¸
        function checkAuth() {
            const token = localStorage.getItem('employee_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            // í† í° ê²€ì¦ ë° ì§ì› ì •ë³´ ë¡œë“œ
            fetch('/api/auth/verify', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Token invalid');
                }
                return response.json();
            })
            .then(user => {
                currentEmployee = user;
                document.getElementById('employeeName').textContent = user.full_name;
                loadEmployeeData();
            })
            .catch(error => {
                console.error('Auth error:', error);
                localStorage.removeItem('employee_token');
                window.location.href = '/login';
            });
        }

        // ì•± ì´ˆê¸°í™”
        function initializeApp() {
            // GPS ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­
            if (navigator.geolocation) {
                getCurrentLocation();
                
                // ìë™ ì¶”ì  ì‹œì‘
                if ('permissions' in navigator) {
                    navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                        if (result.state === 'granted') {
                            startLocationTracking();
                        }
                    });
                }
            } else {
                showAlert('ì´ ê¸°ê¸°ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'warning');
            }

            // ì£¼ê¸°ì  ë°ì´í„° ì—…ë°ì´íŠ¸
            setInterval(updateWorkStatus, 30000); // 30ì´ˆë§ˆë‹¤
            setInterval(loadRecentActivity, 60000); // 1ë¶„ë§ˆë‹¤
        }

        // ì§ì› ë°ì´í„° ë¡œë“œ
        async function loadEmployeeData() {
            try {
                const token = localStorage.getItem('employee_token');
                const response = await fetch('/api/employee/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                updateStatusDisplay(data);
                loadRecentActivity();
                
            } catch (error) {
                console.error('Employee data load error:', error);
                showAlert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            }
        }

        // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                document.getElementById('locationStatus').textContent = 'ìœ„ì¹˜ ì„œë¹„ìŠ¤ ì§€ì› ì•ˆí•¨';
                return;
            }

            document.getElementById('locationStatus').textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date()
                    };
                    
                    updateLocationDisplay();
                    checkGeofenceStatus();
                },
                function(error) {
                    handleLocationError(error);
                },
                options
            );
        }

        // ìœ„ì¹˜ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateLocationDisplay() {
            if (!currentLocation) return;

            const locationIcon = document.getElementById('locationIcon');
            const locationStatus = document.getElementById('locationStatus');
            const locationDetails = document.getElementById('locationDetails');
            const coordinates = document.getElementById('coordinates');

            locationIcon.classList.add('active');
            locationStatus.textContent = 'ìœ„ì¹˜ í™•ì¸ë¨';
            
            if (currentLocation.accuracy <= 50) {
                locationDetails.textContent = `ì •í™•í•œ ìœ„ì¹˜ (ì˜¤ì°¨: ${Math.round(currentLocation.accuracy)}m)`;
            } else {
                locationDetails.textContent = `ìœ„ì¹˜ í™•ì¸ë¨ (ì˜¤ì°¨: ${Math.round(currentLocation.accuracy)}m)`;
            }
            
            coordinates.textContent = 
                `ì¢Œí‘œ: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
            
            // ìœ„ì¹˜ê°€ í™•ì¸ë˜ë©´ ì¦‰ì‹œ ì§€ì˜¤íœìŠ¤ ì²´í¬
            checkGeofenceStatus();
        }

        // ìœ„ì¹˜ ì˜¤ë¥˜ ì²˜ë¦¬
        function handleLocationError(error) {
            const locationStatus = document.getElementById('locationStatus');
            const locationDetails = document.getElementById('locationDetails');
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    locationStatus.textContent = 'ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ë¨';
                    locationDetails.textContent = 'ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    showAlert('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'warning');
                    break;
                case error.POSITION_UNAVAILABLE:
                    locationStatus.textContent = 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ';
                    locationDetails.textContent = 'GPS ì‹ í˜¸ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    break;
                case error.TIMEOUT:
                    locationStatus.textContent = 'ìœ„ì¹˜ í™•ì¸ ì‹œê°„ ì´ˆê³¼';
                    locationDetails.textContent = 'ìœ„ì¹˜ í™•ì¸ì— ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤.';
                    break;
                default:
                    locationStatus.textContent = 'ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨';
                    locationDetails.textContent = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    break;
            }
        }

        // ì§€ì˜¤íœìŠ¤ ìƒíƒœ í™•ì¸
        async function checkGeofenceStatus() {
            if (!currentLocation || !currentEmployee) return;

            try {
                const token = localStorage.getItem('employee_token');
                const response = await fetch('/api/employee/check-location', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        latitude: currentLocation.latitude,
                        longitude: currentLocation.longitude,
                        accuracy: currentLocation.accuracy
                    })
                });

                const result = await response.json();
                updateMainActionButton(result);
                updateLocationDetails(result);
                
            } catch (error) {
                console.error('Geofence check error:', error);
            }
        }

        // ìœ„ì¹˜ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateLocationDetails(locationResult) {
            const locationDetails = document.getElementById('locationDetails');
            const coordinates = document.getElementById('coordinates');
            
            if (locationResult.sites_distances && locationResult.sites_distances.length > 0) {
                // ê°€ì¥ ê°€ê¹Œìš´ ê·¼ë¬´ì§€ ì°¾ê¸°
                const closestSite = locationResult.sites_distances.reduce((prev, current) => {
                    return (prev.distance < current.distance) ? prev : current;
                });
                
                if (closestSite.inside_geofence) {
                    locationDetails.innerHTML = `âˆš <strong>${closestSite.site_name}</strong> ê·¼ë¬´ì§€ ë‚´ (${closestSite.distance}m)`;
                } else {
                    locationDetails.innerHTML = ` <strong>${closestSite.site_name}</strong>ê¹Œì§€ ${closestSite.distance}m`;
                }
                
                // ì¢Œí‘œ ì •ë³´ì— ê·¼ë¬´ì§€ ì¢Œí‘œ í‘œì‹œ
                coordinates.innerHTML = `
                    <div>í˜„ì¬ ìœ„ì¹˜: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}</div>
                    <div>ê·¼ë¬´ì§€ê¹Œì§€: ${closestSite.distance}m</div>
                    <div style="font-size: 0.7rem; margin-top: 0.25rem; color: #868e96;">
                        ê·¼ë¬´ì§€ ì¢Œí‘œ: ${closestSite.latitude.toFixed(6)}, ${closestSite.longitude.toFixed(6)}
                    </div>
                `;
            } else {
                // í• ë‹¹ëœ ê·¼ë¬´ì§€ê°€ ì—†ëŠ” ê²½ìš°ì—ë„ í˜„ì¬ ìœ„ì¹˜ëŠ” í‘œì‹œ
                locationDetails.innerHTML = ` í• ë‹¹ëœ ê·¼ë¬´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. <a href="/my-applications" style="color: #007bff; text-decoration: underline;">ì‹ ì²­ í˜„í™© í™•ì¸</a>`;
                coordinates.textContent = `ì¢Œí‘œ: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
            }
        }

        // ë©”ì¸ ì•¡ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateMainActionButton(locationResult) {
            const mainBtn = document.getElementById('mainActionBtn');
            
            if (locationResult.sites_distances && locationResult.sites_distances.length > 0) {
                // ê°€ì¥ ê°€ê¹Œìš´ ê·¼ë¬´ì§€ ì°¾ê¸°
                const closestSite = locationResult.sites_distances.reduce((prev, current) => {
                    return (prev.distance < current.distance) ? prev : current;
                });
                
                if (closestSite.inside_geofence) {
                    if (workStatus === 'waiting') {
                        mainBtn.textContent = `${closestSite.site_name}ì—ì„œ ì¶œê·¼í•˜ê¸°`;
                        mainBtn.className = 'btn btn-success';
                        mainBtn.disabled = false;
                    } else if (workStatus === 'working') {
                        mainBtn.textContent = 'í‡´ê·¼í•˜ê¸°';
                        mainBtn.className = 'btn btn-danger';
                        mainBtn.disabled = false;
                    } else {
                        mainBtn.textContent = 'ê·¼ë¬´ ì™„ë£Œ';
                        mainBtn.className = 'btn btn-secondary';
                        mainBtn.disabled = true;
                    }
                } else {
                    mainBtn.textContent = `${closestSite.site_name}ê¹Œì§€ ${closestSite.distance}m`;
                    mainBtn.className = 'btn btn-secondary';
                    mainBtn.disabled = true;
                }
            } else {
                // í• ë‹¹ëœ ê·¼ë¬´ì§€ê°€ ì—†ëŠ” ê²½ìš°
                mainBtn.textContent = 'ì¼ìë¦¬ ì‹ ì²­í•˜ê¸°';
                mainBtn.className = 'btn btn-info';
                mainBtn.disabled = false;
                mainBtn.onclick = function() {
                    window.location.href = '/jobs';
                };
            }
        }

        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStatusDisplay(statusData) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusDetails = document.getElementById('statusDetails');
            const checkInTime = document.getElementById('checkInTime');
            const workDuration = document.getElementById('workDuration');

            workStatus = statusData.status;

            // í• ë‹¹ëœ ê·¼ë¬´ì§€ ì •ë³´ í‘œì‹œ
            let workLocationInfo = '';
            if (statusData.assigned_sites && statusData.assigned_sites.length > 0) {
                const siteNames = statusData.assigned_sites.map(site => site.name).join(', ');
                workLocationInfo = ` (í• ë‹¹ëœ ê·¼ë¬´ì§€: ${siteNames})`;
            } else {
                workLocationInfo = ' (ê·¼ë¬´ì§€ ì—†ìŒ - ì¼ìë¦¬ ì‹ ì²­ í•„ìš”)';
            }

            switch (statusData.status) {
                case 'waiting':
                    indicator.textContent = 'â°';
                    statusText.textContent = 'ì¶œê·¼ ëŒ€ê¸°ì¤‘';
                    if (statusData.assigned_sites && statusData.assigned_sites.length > 0) {
                        statusDetails.textContent = 'ê·¼ë¬´ì§€ì— ë„ì°©í•˜ë©´ ì¶œê·¼ ì²´í¬ë¥¼ í•˜ì„¸ìš”' + workLocationInfo;
                    } else {
                        statusDetails.textContent = 'ë¨¼ì € ì¼ìë¦¬ë¥¼ ì‹ ì²­í•´ì£¼ì„¸ìš”. ìŠ¹ì¸ í›„ ê·¼ë¬´ì§€ê°€ ì„¤ì •ë©ë‹ˆë‹¤.';
                    }
                    break;
                case 'working':
                    indicator.textContent = 'ğŸ’¼';
                    statusText.textContent = 'ê·¼ë¬´ì¤‘';
                    statusDetails.textContent = `${statusData.attendance.site_name || 'ê·¼ë¬´ì§€'}ì—ì„œ ê·¼ë¬´ ì¤‘`;
                    if (statusData.attendance.check_in_time) {
                        checkInTime.textContent = new Date(statusData.attendance.check_in_time).toLocaleTimeString('ko-KR');
                        workDuration.textContent = calculateWorkDuration(statusData.attendance.check_in_time);
                    }
                    break;
                case 'completed':
                    indicator.textContent = 'âˆš';
                    statusText.textContent = 'ê·¼ë¬´ ì™„ë£Œ';
                    statusDetails.textContent = 'ì˜¤ëŠ˜ ê·¼ë¬´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
                    if (statusData.attendance.check_in_time) {
                        checkInTime.textContent = new Date(statusData.attendance.check_in_time).toLocaleTimeString('ko-KR');
                        workDuration.textContent = calculateWorkDuration(
                            statusData.attendance.check_in_time, 
                            statusData.attendance.check_out_time
                        );
                    }
                    break;
            }
        }

        // ê·¼ë¬´ ì‹œê°„ ê³„ì‚°
        function calculateWorkDuration(startTime, endTime = null) {
            const start = new Date(startTime);
            const end = endTime ? new Date(endTime) : new Date();
            const diff = end - start;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}ì‹œê°„ ${minutes}ë¶„`;
        }

        // ë©”ì¸ ì•¡ì…˜ ìˆ˜í–‰
        function performMainAction() {
            if (!currentLocation) {
                showAlert('ìœ„ì¹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ìœ„ì¹˜ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”.', 'warning');
                getCurrentLocation();
                return;
            }

            if (workStatus === 'waiting') {
                showConfirmModal('ì¶œê·¼ í™•ì¸', 'ì¶œê·¼ ì²´í¬ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'checkIn');
            } else if (workStatus === 'working') {
                showConfirmModal('í‡´ê·¼ í™•ì¸', 'í‡´ê·¼ ì²´í¬ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'checkOut');
            }
        }

        // í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
        function showConfirmModal(title, message, action) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
            pendingAction = action;
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingAction = null;
        }

        // í™•ì¸ ì•¡ì…˜ ìˆ˜í–‰
        async function confirmAction() {
            if (!pendingAction) return;

            try {
                const token = localStorage.getItem('employee_token');
                const response = await fetch(`/api/employee/${pendingAction}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        latitude: currentLocation.latitude,
                        longitude: currentLocation.longitude,
                        accuracy: currentLocation.accuracy
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert(result.message, 'success');
                    loadEmployeeData(); // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                } else {
                    showAlert(result.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'warning');
                }

            } catch (error) {
                console.error('Action error:', error);
                showAlert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'warning');
            }

            closeModal();
        }

        // ìœ„ì¹˜ ì¶”ì  ì‹œì‘
        function startLocationTracking() {
            if (trackingEnabled) return;

            trackingEnabled = true;
            trackingInterval = setInterval(() => {
                getCurrentLocation();
            }, 300000); // 5ë¶„ë§ˆë‹¤
        }

        // ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€
        function stopLocationTracking() {
            trackingEnabled = false;
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
        }

        // ìœ„ì¹˜ ìƒˆë¡œê³ ì¹¨
        function refreshLocation() {
            getCurrentLocation();
            loadSelectedLocationInfo(); // ì„ íƒëœ ìœ„ì¹˜ ì •ë³´ë„ ìƒˆë¡œê³ ì¹¨
        }
        
        // ì„ íƒëœ ìœ„ì¹˜ ì •ë³´ ë¡œë“œ
        function loadSelectedLocationInfo() {
            const selectedLocationInfo = localStorage.getItem('selectedLocationInfo');
            const selectedLocationCard = document.getElementById('selectedLocationCard');
            
            if (selectedLocationInfo) {
                try {
                    const locationData = JSON.parse(selectedLocationInfo);
                    
                    // ê° ì •ë³´ë¥¼ í™”ë©´ì— í‘œì‹œ
                    document.getElementById('selectedJobTitle').textContent = locationData.jobTitle || '-';
                    document.getElementById('selectedCompanyName').textContent = locationData.companyName || '-';
                    document.getElementById('selectedWorkAddress').textContent = locationData.workAddress || '-';
                    document.getElementById('selectedWorkHours').textContent = locationData.workHours || '-';
                    document.getElementById('selectedSalary').textContent = locationData.salary || '-';
                    
                    // ì¹´ë“œ í‘œì‹œ
                    selectedLocationCard.style.display = 'block';
                } catch (error) {
                    console.error('Error parsing selected location info:', error);
                    selectedLocationCard.style.display = 'none';
                }
            } else {
                // ì„ íƒëœ ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ ì¹´ë“œ ìˆ¨ê¸°ê¸°
                selectedLocationCard.style.display = 'none';
            }
        }

        // ê·¼ë¬´ ì¼ì • ë¡œë“œ
        async function loadWorkSchedule() {
            try {
                const token = localStorage.getItem('employee_token');
                const response = await fetch('/api/my-applications', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    displayWorkSchedule(data.applications);
                } else {
                    document.getElementById('workSchedule').innerHTML = '<div class="loading">ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                
            } catch (error) {
                console.error('Work schedule load error:', error);
                document.getElementById('workSchedule').innerHTML = '<div class="loading">ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ê·¼ë¬´ ì¼ì • í‘œì‹œ
        function displayWorkSchedule(applications) {
            const workSchedule = document.getElementById('workSchedule');
            
            // ìˆ¨ê²¨ì§„ í•­ëª© í•„í„°ë§
            const filteredApps = filterHiddenItems(applications);
            const relevantApps = filteredApps.filter(app => 
                app.status === 'approved' || app.status === 'working' || app.status === 'completed'
            );
            
            if (relevantApps.length === 0) {
                workSchedule.innerHTML = '<div class="loading">ì˜ˆì •ëœ ê·¼ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = '';
            relevantApps.forEach(app => {
                const statusClass = app.status === 'completed' ? 'completed' : 
                                  app.status === 'working' ? 'working' : '';
                const statusText = app.status === 'completed' ? 'ì™„ë£Œ' :
                                  app.status === 'working' ? 'ê·¼ë¬´ì¤‘' : 'ì˜ˆì •';
                const workDate = app.work_start_date ? 
                    new Date(app.work_start_date).toLocaleDateString('ko-KR') : 'ë¯¸ì •';
                
                html += `
                    <div class="schedule-item ${statusClass}">
                        <div class="schedule-info">
                            <div class="schedule-title">${app.job_post.title}</div>
                            <div class="schedule-details">
                                ${app.job_post.company_name} Â· ${workDate} Â· ${statusText}
                                ${app.job_post.work_hours ? ` Â· ${app.job_post.work_hours}` : ''}
                            </div>
                        </div>
                        <div class="schedule-actions">
                            <button class="btn-small btn-delete" onclick="deleteWorkItem(${app.id})">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });

            workSchedule.innerHTML = html;
        }

        // ê·¼ë¬´ í•­ëª© ì‚­ì œ (í”„ë¡ íŠ¸ì—”ë“œì—ì„œë§Œ)
        function deleteWorkItem(applicationId) {
            if (!confirm('ì´ í•­ëª©ì„ ëª©ë¡ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹¤ì œ ì‹ ì²­ì€ ì·¨ì†Œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) {
                return;
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìˆ¨ê¹€ ëª©ë¡ ì €ì¥
            let hiddenItems = JSON.parse(localStorage.getItem('hiddenWorkItems') || '[]');
            if (!hiddenItems.includes(applicationId)) {
                hiddenItems.push(applicationId);
                localStorage.setItem('hiddenWorkItems', JSON.stringify(hiddenItems));
            }
            
            // í™”ë©´ ìƒˆë¡œê³ ì¹¨
            loadWorkSchedule();
        }

        // ìˆ¨ê²¨ì§„ í•­ëª© í•„í„°ë§
        function filterHiddenItems(applications) {
            const hiddenItems = JSON.parse(localStorage.getItem('hiddenWorkItems') || '[]');
            return applications.filter(app => !hiddenItems.includes(app.id));
        }

        // ìµœê·¼ í™œë™ ë¡œë“œ
        async function loadRecentActivity() {
            try {
                const token = localStorage.getItem('employee_token');
                const response = await fetch('/api/employee/recent-activity', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const activities = await response.json();
                displayActivities(activities);
                
            } catch (error) {
                console.error('Recent activity load error:', error);
            }
        }

        // í™œë™ í‘œì‹œ
        function displayActivities(activities) {
            const activityLog = document.getElementById('activityLog');
            
            if (activities.length === 0) {
                activityLog.innerHTML = '<div class="loading">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = '';
            activities.forEach(activity => {
                const time = new Date(activity.timestamp).toLocaleString('ko-KR');
                const iconClass = activity.event_type === 'check_in' ? 'check-in' :
                                 activity.event_type === 'check_out' ? 'check-out' : 'location';
                
                html += `
                    <div class="activity-item">
                        <div class="activity-icon ${iconClass}"></div>
                        <div class="activity-content">
                            <div class="activity-text">${getActivityText(activity)}</div>
                            <div class="activity-time">${time}</div>
                        </div>
                    </div>
                `;
            });

            activityLog.innerHTML = html;
        }

        // í™œë™ í…ìŠ¤íŠ¸ ìƒì„±
        function getActivityText(activity) {
            switch (activity.event_type) {
                case 'check_in':
                    return `${activity.site_name}ì—ì„œ ì¶œê·¼`;
                case 'check_out':
                    return `${activity.site_name}ì—ì„œ í‡´ê·¼`;
                case 'geofence_enter':
                    return `${activity.site_name} êµ¬ì—­ ì§„ì…`;
                case 'geofence_exit':
                    return `${activity.site_name} êµ¬ì—­ ì´íƒˆ`;
                default:
                    return 'ìœ„ì¹˜ ì—…ë°ì´íŠ¸';
            }
        }

        // ì¶œì… ê¸°ë¡ ë³´ê¸°
        function viewHistory() {
            window.open('/employee/history', '_self');
        }

        // ê·¼ë¬´ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateWorkStatus() {
            if (currentEmployee) {
                loadEmployeeData();
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'info') {
            // ê°„ë‹¨í•œ ì•Œë¦¼ êµ¬í˜„
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '80px';
            alertDiv.style.left = '1rem';
            alertDiv.style.right = '1rem';
            alertDiv.style.zIndex = '1001';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 5000);
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem('employee_token');
            window.location.href = '/login';
        }
    </script>
</body>
</html>